# سيناريوهات تشغيل المشروع (البساطة + الاحترافية)

هذا الملف يجمع أهم السيناريوهات العملية (Use Cases) بشكل مختصر ومنظم لدعم الفهم السريع وتسهيل التطوير المستقبلي.

## منهجية التوثيق
لكل سيناريو نعرض: الهدف، الجهات الفاعلة، التدفق الأساسي، بدائل/أخطاء، معايير القبول.

---
## 1. تسجيل مستخدم جديد (بريد عمل)
- الهدف: إنشاء حساب مستخدم بصلاحيات أساسية.
- الجهات: زائر، نظام التحقق، مخزن المستخدمين.
- التدفق:
  1. يملأ النموذج (شركة، بريد، كلمة مرور...).
  2. النظام يتحقق من أن البريد ليس نطاقًا شخصيًا (إلا إذا AUTO_APPROVE=1).
  3. حفظ المستخدم، توليد رمز بسيط (token) صالح 24 ساعة.
  4. (اختياري) إرسال بريد تحقق.
- البدائل/أخطاء:
  - بريد شخصي مرفوض → رسالة واضحة.
  - كلمة مرور أقل من الحد → رفض.
- القبول:
  - رجوع { ok:true, token, user }.
  - عدم قبول نطاقات محظورة.

## 2. تسجيل الدخول
- الهدف: إصدار جلسة مؤقتة للمستخدم.
- التدفق: يتحقق من البريد/النمط، إنشاء token جديد، إرجاع بيانات المستخدم.
- أخطاء: غياب الحقول، صيغة بريد غير صحيحة.
- القبول: { ok:true, token }.

## 3. إنشاء عرض سعر (مسودة)
- الهدف: حفظ مسودة عرض سعر مرتبطة بالمستخدم.
- التدفق:
  1. يرسل المستخدم بيانات العرض (items, client, project...).
  2. إنشاء معرف تسلسلي (QT-YYYY-###).
  3. تخزين البيانات في file storage + سجل activity.
  4. إرسال إشعار بريد (اختياري) للمستخدم/الإدارة.
- أخطاء: عدم وجود projectName (يُولد تلقائياً إذا AUTO_APPROVE=1).
- القبول: { ok:true, id } وتخزينها في quotations.json.

## 4. استعراض قائمة عروض الأسعار
- الهدف: رؤية تاريخ العروض + بعض أمثلة وهمية (للديمو).
- القبول: قائمة مع total وعدد.

## 5. عرض تفاصيل عرض واحد
- الهدف: تمكين المستخدم من مراجعة التاريخ والمراجعات.
- القبول: رجوع سجل يحتوي (history[], revision، الحالة).

## 6. تعديل عرض (Draft / قيد المراجعة)
- الهدف: تحديث المسودة قبل الإرسال النهائي.
- التدفق:
  1. PATCH يتضمن تغييرات payload.
  2. النظام يقارن payload السابق والجديد.
  3. إذا تغيّر → إضافة نسخة للتاريخ + زيادة revision.
- أخطاء: محاولة تعديل حالة غير قابلة للتعديل.
- القبول: revision محدث + history أحدث عنصر يمثل snapshot سابق.

## 7. استنساخ عرض
- الهدف: إعادة استخدام عرض سابق لبناء عرض مشابه جديد.
- التدفق:
  1. POST clone.
  2. إنشاء معرف جديد بنفس الطريقة.
  3. إعادة التعيين للحالة مسودة، history فارغ.
- القبول: { ok:true, quotation }.

## 8. إرسال بريد إشعار (عند الحفظ)
- الهدف: متابعة داخلية وتنبيه المستخدم.
- التدفق: محاولة إرسال بريدين (admin + user) إن توفرت مفاتيح البريد.
- أخطاء: فشل الإرسال → لا يمنع نجاح الحفظ.
- القبول: لا يكسر العملية.

## 9. التحقق من البريد التجاري
- الهدف: حماية المنصة من التسجيل ببريد شخصي.
- أدوات: `validateBusinessEmail`.
- القبول: رفض واضح للبريد الشخصي، دعم allow/deny lists.

## 10. حماية المعدل (Rate Limiting) لمسارات المستخدم
- الهدف: منع الإساءة.
- التدفق: مراقبة IP لكل دقيقة.
- القبول: 429 عند تجاوز الحد.

## 11. وضع الأوفلاين (Offline Mode للذكاء الاصطناعي)
- الهدف: استمرار الخدمة بدون مزودي AI.
- التدفق: orchestrator يشغل --offline → يتم تفعيل منطق fallback و cache.
- القبول: عدم رمي أخطاء قاتلة عند غياب API Keys.

## 12. كسر الدائرة (Circuit Breaker) لمقدمي AI
- الهدف: حماية التطبيق عند فشل متكرر.
- التدفق: بعد N أخطاء متتالية → تعطيل مؤقت.
- القبول: تسجيل التعطيل + محاولة بعد فترة تبريد.

## 13. الفوترة/الاشتراكات (مستقبلية)
- الهدف: تمكين حدود استخدام حسب الخطط.
- المخزن: `pricing-tiers.json` + توثيق في INSTRUCTION.md.
- القبول: سهولة ربط عدادات لاحقًا (e.g. عدد العروض، استدعاءات AI).

## 14. إدارة النشاط (Activity Log)
- الهدف: تتبع تصرفات المستخدم.
- التدفق: كل حدث (save, view, update, clone) يسجل في `activity.json` (أقصى 1000).
- القبول: استرجاع سريع في لوحة الإدارة.

## 15. سيناريو خطأ تخزين الملف
- السبب: فشل كتابة /tmp في الإنتاج.
- الحل: try/catch وإرجاع 500 مع تحذير في السجل.
- القبول: عدم انهيار السيرفر.

## 16. سيناريو توسّع (الانتقال لقاعدة بيانات)
- الهدف: ترقية التخزين.
- الاعتبارات: ترحيل history، فهرسة حسب userId/email، إضافة soft delete.

## 17. سيناريو أمان المفاتيح
- الهدف: عدم تسريب الأسرار.
- الأدوات: فحص أسرار (`scan-secrets`)، hook قبل الالتزام، تحميل محلي ديناميكي.
- القبول: عدم دفع ملفات حساسة إلى Git.

## 18. سيناريو إنشاء PDF قوي (Roadmap)
- تحويل عرض السعر إلى PDF احترافي (مذكور في وثائق أخرى)، دمج الصور + جداول منظمة.

## 19. سيناريو تعريب واجهة المستخدم المختلط
- الهدف: دعم عربي/إنجليزي ديناميكي في عناصر الواجهة.
- القبول: اختيار تلقائي حسب المحتوى أو تفضيل المستخدم.

## 20. سيناريو مسار قبول مستقبلي (Submit/Approve)
- الهدف: دورة حياة متقدمة للحالات.
- التخطيط: إضافة حالات (submitted, approved, rejected) + سجل انتقالات.

---
## معايير تصميم السيناريوهات
- البساطة: كل سيناريو <= 7 خطوات أساسية.
- الوضوح: مصطلحات عربية مدعومة بإنجليزية عند الحاجة في الكود فقط.
- القابلية للتوسعة: تمهيد واضح للانتقال لقواعد بيانات أو مزايا مدفوعة.

## اقتراحات مستقبلية
| أولوية | تحسين | وصف مختصر |
|--------|--------|-----------|
| عالية | Workflow للحالات | إضافة submit/approve + إشعارات |
| متوسطة | PDF متقدم | قوالب متعددة + علامة مائية للحالة |
| متوسطة | Dashboard مؤشرات | عدادات استخدام AI، عروض/مستخدم، معدل قبول |
| منخفضة | Webhooks | تكامل CRM خارجي عند (create/approve) |
| منخفضة | Tags/Labels | تصنيف عروض (region, segment) |

---
تم تلخيص أهم ما يلامس احتياجك الآن، أخبرني إن أردت تفصيل أي سيناريو أو تحويله لقائمة مهام تنفيذية.
