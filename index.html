<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QIQ Chat + Algolia Agent</title>
    <style>
      :root {
        --bg:#f6f7fb;
        --card:#ffffff;
        --border:#e5e7eb;
        --text:#111827;
        --muted:#6b7280;
        --primary:#0ea5e9;
        --send:#111827;
      }
      body {
        margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Arial;
        background:var(--bg); color:var(--text);
      }
      .wrap {
        max-width: 980px; margin: 24px auto; padding: 0 12px;
      }
      .card {
        background:var(--card); border:1px solid var(--border);
        border-radius:14px; overflow:hidden;
      }
      .window {
        min-height: 440px; max-height: 560px; overflow:auto;
        background:#f8fafc; padding:16px;
      }
      .msg { margin:10px 0; line-height:1.55; }
      .bubble {
        display:inline-block; padding:10px 12px; border-radius:12px;
        max-width:95%; white-space:pre-wrap; word-break:break-word;
        background:#fff; border:1px solid var(--border);
      }
      .msg.user { text-align:left; } /* Ù„Ø£Ù†Ù†Ø§ RTLØŒ Ø®Ù„ÙŠÙ‡ ÙŠØ¨Ø§Ù† ÙŠØ³Ø§Ø± */
      .msg.user .bubble { background:#2563eb; border-color:#2563eb; color:#fff; }
      .form {
        display:flex; gap:8px; border-top:1px solid var(--border);
        padding:10px; background:#fff; align-items:center;
      }
      .input {
        flex:1; border:1px solid var(--border); border-radius:10px; padding:10px;
      }
      .btn, .send {
        border:0; border-radius:10px; padding:10px 14px; cursor:pointer; color:#fff;
      }
      .btn { background:#0ea5e9; }
      .send { background:var(--send); }
      .muted { color:var(--muted); font-size:12px; margin-top:6px; }
      .results {
        margin:12px 0 4px;
        background:#fff; border:1px dashed var(--border); border-radius:12px; padding:12px;
      }
      .result {
        display:grid; grid-template-columns: 72px 1fr auto; gap:12px; align-items:center;
        border-bottom:1px solid #eef2f7; padding:10px 0;
      }
      .result:last-child { border-bottom:0; }
      .thumb {
        width:64px; height:64px; object-fit:contain; border:1px solid #eee; border-radius:8px; background:#fff;
      }
      .link { color:#2563eb; text-decoration:none; }
      .price { font-weight:600; white-space:nowrap; }
      .loading {
        display:inline-block; width:14px; height:14px; border:2px solid #cbd5e1;
        border-top-color:#0ea5e9; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:-2px;
      }
      @keyframes spin { to { transform: rotate(360deg) } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div id="win" class="window" aria-live="polite"></div>

        <form id="form" class="form" autocomplete="off">
          <input id="inp" class="input" type="text"
                 placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒâ€¦ Ù…Ø«Ù„Ø§Ù‹: Kaspersky Ù„Ù…Ø¯Ø© Ø³Ù†ØªÙŠÙ† Ù„Ù€ 120 Ù…Ø³ØªØ®Ø¯Ù…" required />
          <button class="btn" type="button" id="btnSearch">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª</button>
          <button class="send" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
        </form>
      </div>

      <div class="muted">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø²Ø± â€œØ§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øªâ€ Ø¨ÙŠØ³ØªØ®Ø¯Ù… Algolia Agent Studio Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§ÙˆØª <code>/api/search</code>.
      </div>
    </div>

    <script>
      // Ø¹Ù†Ø§ØµØ± DOM
      const win  = document.getElementById('win');
      const form = document.getElementById('form');
      const inp  = document.getElementById('inp');
      const btnSearch = document.getElementById('btnSearch');

      // Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª
      function addMsg(role, html, asHtml=false) {
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.dir = 'auto';
        if (asHtml) bubble.innerHTML = html;
        else bubble.textContent = html;
        wrap.appendChild(bubble);
        win.appendChild(wrap);
        win.scrollTop = win.scrollHeight;
        return bubble;
      }
      function esc(s){ return (s ?? '').toString().replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

      // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
      addMsg('bot', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ QuickITQuote ğŸ‘‹\nØ§Ø³Ø£Ù„ Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ø±Ø®ØµØ©ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± â€œØ§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øªâ€.');

      // ============ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Agent Ø¹Ø¨Ø± /api/search ============
      async function agentSearch(query) {
        // Ù†Ø¨Ø¹Ø« request Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙˆØª Ø§Ù„Ø³ÙŠØ±ÙØ±ÙŠ (Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙƒÙ„Ù‘Ù… Agent Studio)
        const r = await fetch('/api/search', {
          method: 'POST',
          headers: { 'content-type':'application/json' },
          body: JSON.stringify({ query })
        });

        if (!r.ok) {
          let errText = await r.text().catch(()=> '');
          throw new Error(`Search API error ${r.status}: ${errText || r.statusText}`);
        }
        return r.json();
      }

      // Ø±Ø³Ù… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø¨Ø³ÙŠØ·)
      function renderAgentResults(agentResponse) {
        // Ø´ÙƒÙ„ Ø§Ù„Ù€ response Ù…Ù† Agent Studio Ù…Ù…ÙƒÙ† ÙŠØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
        // Ø£Ø¨Ø³Ø· Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: Ù†Ø¹Ø±Ø¶ Ù†Øµ Ø§Ù„Ø±Ø¯ ÙˆÙ„Ùˆ ÙÙŠÙ‡ Ø±ÙˆØ§Ø¨Ø· Ù…Ù†ØªØ¬Ø§Øª Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙƒØ±ØªÙ….
        const container = document.createElement('div');
        container.className = 'results';

        // 1) Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø±Ø¯ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
        const text = agentResponse?.answer
                  || agentResponse?.output_text
                  || agentResponse?.content
                  || '';

        if (text) {
          const p = document.createElement('p');
          p.style.margin = '8px 0 12px';
          p.textContent = text;
          container.appendChild(p);
        }

        // 2) Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Products Ù…Ù† payload Ø§Ù„Ø´Ø§Ø¦Ø¹ (Ù„Ùˆ Ø§Ù„Ù€ Agent Ù…ÙˆÙ„Ù‘Ø¯ Cards)
        //  - Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ±Ø¬Ù‘Ø¹Ù‡Ø§ ÙÙŠ tools/steps/â€¦ Ø£Ùˆ ÙÙŠ field Ù…Ø«Ù„ products/cards.
        //  - Ù‡Ù†Ø­Ø§ÙˆÙ„ Ù†Ù„Ø§Ù‚ÙŠ Ù…ØµÙÙˆÙØ© objects ÙÙŠÙ‡Ø§ name/link/price/image
        const candidates = [];

        // Ù…Ø³Ø§Ø¹Ø¯Ø© ØµØºÙŠØ±Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØµÙÙˆÙØ§Øª Ù…Ù† Ø£Ù…Ø§ÙƒÙ† Ù…Ø­ØªÙ…Ù„Ø©
        function collectArrays(obj) {
          if (!obj || typeof obj !== 'object') return;
          for (const k of Object.keys(obj)) {
            const v = obj[k];
            if (Array.isArray(v)) candidates.push(v);
            if (v && typeof v === 'object') collectArrays(v);
          }
        }
        collectArrays(agentResponse);

        // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù„Ø§Ù‚ÙŠ Ø¹Ù†Ø§ØµØ± Ø´ÙƒÙ„Ù‡Ø§ Products
        let products = null;
        for (const arr of candidates) {
          const looksLikeProducts =
            arr.length && arr.every(x =>
              x && typeof x === 'object' && (
                 x.name || x.title || x.productTitle || x.product_name
              )
            );
          if (looksLikeProducts) { products = arr; break; }
        }

        if (products && products.length) {
          products.slice(0, 5).forEach(p => {
            const name  = p.name || p.title || p.productTitle || p.product_name || '(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)';
            const link  = p.link || p.url || p.permalink || '';
            const img   = p.image || p.image_url || p.thumbnail || '';
            const price = p.price || p.list_price || p.unit_price || '';

            const row = document.createElement('div');
            row.className = 'result';

            const im = document.createElement('img');
            im.className = 'thumb';
            im.src = img || 'https://via.placeholder.com/68?text=IMG';
            im.alt = name;
            row.appendChild(im);

            const info = document.createElement('div');
            const title = document.createElement('div');
            if (link) {
              title.innerHTML = `<a class="link" target="_blank" rel="noopener" href="${esc(link)}">${esc(name)}</a>`;
            } else {
              title.textContent = name;
            }
            info.appendChild(title);
            row.appendChild(info);

            const pr = document.createElement('div');
            pr.className = 'price';
            pr.textContent = price ? String(price) : '';
            row.appendChild(pr);

            container.appendChild(row);
          });
        } else {
          // Ù„Ùˆ Ù…ÙÙŠØ´ Products ÙˆØ§Ø¶Ø­Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø³ÙŠØ·Ø©
          const hint = document.createElement('div');
          hint.style.color = '#6b7280';
          hint.textContent = 'Ù„Ù… Ù†Ø¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù†ØªØ¬Ø§Øª ØµØ±ÙŠØ­Ø© ÙÙŠ Ø±Ø¯ Ø§Ù„Ù€ Agent â€” ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙÙ‚Ø·.';
          container.appendChild(hint);
        }

        return container.outerHTML;
      }

      // Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù… (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ /api/chat Ù…Ù…ÙƒÙ† ØªØ³ØªØ®Ø¯Ù…Ù‡. Ù‡Ù†Ø§ Ø¨Ù†Ø¹Ø±Ø¶ echo Ø¨Ø³ÙŠØ·)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const q = (inp.value || '').trim(); if (!q) return;
        inp.value = '';
        addMsg('user', q);

        // Ø±Ø¯ Ø¨Ø³ÙŠØ· Ù…Ø­Ù„ÙŠâ€”Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ /api/chat Ø§Ø±Ø¨Ø·Ù‡ Ù‡Ù†Ø§
        const b = addMsg('bot', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦ ');
        b.innerHTML = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ´ÙˆÙ Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø·Ù„Ø¨Ùƒ Ø§Ø¶ØºØ· Ø²Ø± â€œØ§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øªâ€.';
      });

      // Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø¹Ø¨Ø± Agent
      btnSearch.addEventListener('click', async () => {
        const q = (inp.value || '').trim();
        if (!q) { inp.focus(); return; }

        const bubble = addMsg('bot', `Ø¨Ø­Ø«: ${q} <span class="loading"></span>`, true);
        try {
          const resp = await agentSearch(q);
          const html = renderAgentResults(resp);
          bubble.innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.';
        } catch (err) {
          console.error(err);
          bubble.textContent = 'Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø­Ø«.';
        }
      });
    </script>
  </body>
</html>
