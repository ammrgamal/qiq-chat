<script>
  async function sendMessage() {
    const input = document.getElementById('msg');
    const msg = input.value.trim();
    if (!msg) return;

    try {
      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [{ role: 'user', content: msg }] })
      });

      // حاول تقرا JSON، ولو فشل اقرأ نص عادي
      let payload;
      const text = await r.text();
      try { payload = JSON.parse(text); } catch { payload = { error: text }; }

      if (!r.ok) {
        throw new Error(payload?.error || 'Request failed');
      }

      // OpenAI payload -> payload.choices[0].message.content
      const reply = payload?.choices?.[0]?.message?.content || '(no content)';
      appendToChat('assistant', reply);

    } catch (e) {
      appendToChat('error', e.message);
    } finally {
      input.value = '';
    }
  }
</script>
