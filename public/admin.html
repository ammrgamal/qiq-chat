<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة الإدارة - QuickITQuote Admin</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    .admin-header { background: #1f2937; color: #fff; padding: 16px 0; margin-bottom: 24px; }
    .admin-nav { display: flex; gap: 16px; align-items: center; }
    .admin-nav a { color: #d1d5db; text-decoration: none; padding: 8px 12px; border-radius: 6px; }
    .admin-nav a:hover, .admin-nav a.active { background: #374151; color: #fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    .stat-number { font-size: 24px; font-weight: bold; color: #059669; }
    .data-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: right; }
    .data-table th { background: #f9fafb; font-weight: 600; }
    .filter-bar { background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .filter-bar input, .filter-bar select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; }
    .btn-admin { background: #2563eb; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-admin:hover { background: #1d4ed8; }
    .btn-danger { background: #dc2626; }
    .btn-danger:hover { background: #b91c1c; }
    .status-chip { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    .status-active { background: #dcfce7; color: #166534; }
    .status-inactive { background: #fef3c7; color: #92400e; }
    .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px; }
    .tab { padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="admin-header">
    <div class="qiq-container">
      <div class="admin-nav">
        <strong>QuickITQuote Admin</strong>
        <a href="#dashboard" class="tab-link active">Dashboard</a>
        <a href="#users" class="tab-link">المستخدمين</a>
  <a href="#quotations" class="tab-link">العروض</a>
  <a href="/admin-quotes.html" style="color:#93c5fd">نسخة العروض المنفصلة ↗</a>
  <a href="#activity" class="tab-link">النشاط</a>
  <a href="#config" class="tab-link">الإعدادات الذكية</a>
        <a href="#v0check" class="tab-link">فحص V0</a>
        <div style="margin-inline-start: auto;">
          <span id="admin-user">Admin User</span>
          <button id="btn-logout" class="btn-admin">خروج</button>
        </div>
      </div>
    </div>
  </div>

  <main class="qiq-container">
    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <h2>نظرة عامة</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="stat-users">0</div>
          <div>إجمالي المستخدمين</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-quotations">0</div>
          <div>إجمالي العروض</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-today">0</div>
          <div>عروض اليوم</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-active">0</div>
          <div>مستخدمين نشطين</div>
        </div>
      </div>
      
      <div class="qiq-card">
        <h3>آخر النشاطات</h3>
        <div id="recent-activity">جاري التحميل...</div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
      <h2>إدارة المستخدمين</h2>
      
      <div class="filter-bar">
        <input type="text" id="users-search" placeholder="البحث بالاسم أو البريد..." />
        <select id="users-status">
          <option value="">كل الحالات</option>
          <option value="verified">متحقق</option>
          <option value="unverified">غير متحقق</option>
        </select>
        <button class="btn-admin" onclick="exportUsers()">تصدير CSV</button>
      </div>
      
      <table class="data-table" id="users-table">
        <thead>
          <tr>
            <th>الشركة</th>
            <th>البريد الإلكتروني</th>
            <th>الهاتف</th>
            <th>تاريخ التسجيل</th>
            <th>آخر نشاط</th>
            <th>الحالة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="7">جاري التحميل...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Quotations Tab -->
    <div id="quotations" class="tab-content">
      <h2>إدارة العروض</h2>
      
      <div class="filter-bar">
        <input type="text" id="quotations-search" placeholder="البحث برقم العرض أو العميل..." />
        <select id="quotations-status">
          <option value="">كل الحالات</option>
          <option value="مسودة">مسودة</option>
          <option value="قيد المراجعة">قيد المراجعة</option>
          <option value="مكتمل">مكتمل</option>
        </select>
        <input type="date" id="quotations-date" />
        <button class="btn-admin" onclick="exportQuotations()">تصدير CSV</button>
      </div>
      
      <table class="data-table" id="quotations-table">
        <thead>
          <tr>
            <th>رقم العرض</th>
            <th>العميل</th>
            <th>المستخدم</th>
            <th>التاريخ</th>
            <th>القيمة</th>
            <th>الحالة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="quotations-tbody">
          <tr><td colspan="7">جاري التحميل...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Activity Tab -->
    <div id="activity" class="tab-content">
      <h2>سجل النشاطات</h2>
      
      <div class="filter-bar">
        <input type="text" id="activity-search" placeholder="البحث في النشاطات..." />
        <select id="activity-action">
          <option value="">كل الإجراءات</option>
          <option value="quotation_save">حفظ عرض</option>
          <option value="quotations_view">عرض العروض</option>
          <option value="user_login">تسجيل دخول</option>
          <option value="user_register">تسجيل جديد</option>
        </select>
        <input type="date" id="activity-date" />
        <button class="btn-admin" onclick="exportActivity()">تصدير CSV</button>
      </div>
      
      <table class="data-table" id="activity-table">
        <thead>
          <tr>
            <th>الوقت</th>
            <th>المستخدم</th>
            <th>الإجراء</th>
            <th>التفاصيل</th>
          </tr>
        </thead>
        <tbody id="activity-tbody">
          <tr><td colspan="4">جاري التحميل...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- V0 Check Tab -->
  <div id="v0check" class="tab-content">
    <h2>فحص V0</h2>
    <div class="qiq-card" style="display:grid;gap:12px">
      <div id="v0-status-line" style="display:flex;align-items:center;gap:8px">
        <span id="v0-ready-chip" class="status-chip">جارِ الفحص…</span>
        <span id="v0-ready-details" class="muted" style="font-size:12px"></span>
        <button id="v0-retry" class="btn-admin" style="margin-inline-start:auto">إعادة الفحص</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="qiq-card">
          <h4 style="margin-top:0">مفاتيح وبيئة التشغيل</h4>
          <div id="v0-env-chips" style="display:flex;gap:8px;flex-wrap:wrap"></div>
          <div id="v0-env-notes" class="muted" style="margin-top:8px"></div>
        </div>
        <div class="qiq-card">
          <h4 style="margin-top:0">طلب عيّنة</h4>
          <div id="v0-sample-result" class="muted">—</div>
        </div>
      </div>
      <div class="qiq-card">
        <h4 style="margin-top:0">معاينة مخرجات V0</h4>
        <iframe id="v0-preview" sandbox="allow-same-origin" style="width:100%;height:320px;border:1px solid #e5e7eb;border-radius:8px;background:#fff"></iframe>
      </div>
    </div>
  </div>

  <!-- Config Tab -->
  <div id="config" class="tab-content">
    <h2>الإعدادات الذكية (تعليمات + Bundles)</h2>
    <div class="qiq-card">
      <div style="display:grid;gap:8px">
        <div id="cfg-env-info" class="muted" style="margin-bottom:8px"></div>
        <!-- Connectivity Card -->
        <div id="connectivity-card" style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#f9fafb">
          <div style="font-weight:600;margin-bottom:8px">اتصال الخدمات (Connectivity)</div>
          <div id="connectivity-status" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>
        <fieldset style="border:1px solid #e5e7eb;border-radius:8px;padding:8px">
          <legend style="color:#374151;font-size:12px">AI & Approval</legend>
          <label class="checkbox" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="cfg-ai-override" />
            <span>تفعيل Auto Approve (سماح تلقائي بجلب الصور/الروابط للذكاء الاصطناعي)</span>
          </label>
          <label style="margin-top:6px">النطاقات المسموح بها (واحد في كل سطر):</label>
          <textarea id="cfg-ai-allowed" rows="3" placeholder="example.com
cdn.example.org" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px"></textarea>
          <div class="muted" style="font-size:12px">إذا تُركت القائمة فارغة سيتم السماح بكل النطاقات عند التفعيل.</div>
        </fieldset>
        <fieldset style="border:1px solid #e5e7eb;border-radius:8px;padding:8px">
          <legend style="color:#374151;font-size:12px">PDF Output</legend>
          <label class="checkbox" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="cfg-pdf-images" />
            <span>تضمين صور المنتجات (BOQ Thumbnails)</span>
          </label>
          <label class="checkbox" style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input type="checkbox" id="cfg-pdf-logos" />
            <span>إدراج شعارات الشركاء في صفحة الخاتمة</span>
          </label>
          <label class="checkbox" style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input type="checkbox" id="cfg-pdf-proservices" />
            <span>إظهار بند الخدمات الاحترافية (5% حد أدنى 200)</span>
          </label>
          <div class="muted" style="font-size:12px">مفعّل افتراضياً في الإنتاج، ويمكن تعطيله هنا.</div>
        </fieldset>
        <label>تعليمات ديناميكية:</label>
        <textarea id="cfg-instructions" rows="8" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px"></textarea>
        <label>Bundles (JSON Array):</label>
        <textarea id="cfg-bundles" rows="6" placeholder='[{"name":"10 data points","description":"Includes cabling & termination"}]' style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn-admin" id="cfg-load">تحميل</button>
          <button class="btn-admin" id="cfg-save">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="admin-login-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999">
    <div class="qiq-card" style="max-width:400px;width:90%">
      <h3>دخول المدير</h3>
      <form id="admin-login-form">
        <div style="margin-bottom:12px">
          <label>كلمة مرور المدير:</label>
          <input type="password" id="admin-password" required style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px" />
        </div>
        <div style="text-align:center">
          <button type="submit" class="btn-admin">دخول</button>
        </div>
      </form>
      <div id="admin-login-error" style="color:#dc2626;margin-top:8px;text-align:center"></div>
    </div>
  </div>

  <script src="/js/toast.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>
  <script src="/js/pdf-arabic-fonts.js"></script>
  <script src="/js/pdf-admin.js"></script>
  <script src="/js/admin.js"></script>
  <script src="/js/experimental-banner.js"></script>
  <script>
    // Lightweight connectivity fetcher for HelloLeads/Resend/OpenAI/Gemini
    (function(){
      function chip(name, ok, extra){
        const color = ok ? '#dcfce7' : '#fee2e2';
        const fg = ok ? '#166534' : '#991b1b';
        const title = extra || '';
        return `<span title="${title}" style="display:inline-block;padding:2px 8px;border-radius:999px;background:${color};color:${fg};font-size:12px">${name}: ${ok?'OK':'—'}</span>`;
      }
      fetch('/health').then(r=>r.json()).then(h=>{
        const env = h?.env || {};
        const html = [
          chip('AUTO_APPROVE', !!env.autoApprove),
          chip('OpenAI', !!env.hasOpenAI),
          chip('Gemini', !!env.hasGemini),
          chip('Resend', !!env.hasResend, env.emailFrom?('From: '+env.emailFrom):''),
          chip('HelloLeads', !!env.hasHelloLeads)
        ].join(' ');
        const el = document.getElementById('connectivity-status');
        if (el) el.innerHTML = html;
      }).catch(()=>{
        const el = document.getElementById('connectivity-status');
        if (el) el.innerHTML = '<span style="color:#991b1b">تعذر قراءة الحالة</span>';
      });
    })();
  </script>
</body>
</html>