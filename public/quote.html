<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>طلب عرض سعر | QuickITQuote</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- SheetJS for Excel import/export functionality -->
  <script>
    // Simple Excel-compatible CSV with .xls extension as fallback if SheetJS fails
    window.XLSX_FALLBACK = true;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="console.warn('XLSX library failed to load, using fallback')"></script>
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; --accent:#2563eb; --bg:#f8fafc; --ok:#059669; }
    body{ font-family:Inter,system-ui,Segoe UI,Arial; background:#fff; color:#111; margin:0 }
    .container{ max-width:1000px; margin:20px auto; padding:16px }
    .card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; margin-bottom:14px }
    .row{ display:grid; gap:10px; grid-template-columns:repeat(12,1fr) }
    .col-12{ grid-column:span 12 } .col-6{ grid-column:span 6 } .col-4{ grid-column:span 4 } .col-3{ grid-column:span 3 }
    label{ font-size:13px; color:#374151; display:block; margin-bottom:6px }
    input,select,textarea{ width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px; background:#fff }
    textarea{ min-height:90px; resize:vertical }
    .muted{ color:var(--muted); font-size:12px }
    .flex{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .right{ margin-inline-start:auto }
    .btn{ border:0; border-radius:10px; padding:10px 14px; background:#374151; color:#fff; cursor:pointer }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-primary{ background:var(--accent) }
    .btn-ok{ background:var(--ok) }
    .table-wrap{ overflow:auto }
    table{ width:100%; border-collapse:collapse; table-layout:fixed }
    th,td{ border-bottom:1px solid var(--border); padding:10px; vertical-align:top; text-align:right }
    tfoot td{ font-weight:700 }
    .totals{ display:grid; gap:8px; grid-template-columns:1fr auto; align-items:center; margin-top:10px }
    .quote-head{ display:flex; align-items:center; gap:14px; margin:8px 0 14px }
    .logo{ width:120px; height:56px; object-fit:contain; border:1px dashed var(--border); border-radius:8px; background:#fff }
    .print-only{ display:none }
    @media print{
      .no-print{ display:none !important }
      .print-only{ display:block }
      body{ background:#fff }
      .card{ break-inside:avoid }
    }
    .notice{ background:#f0f9ff; border:1px solid #dbeafe; color:#0c4a6e; padding:8px 10px; border-radius:10px; font-size:13px }
    .checkbox{ display:flex; align-items:center; gap:8px }
    .btn-danger{ background:#dc2626 !important; }
    .btn-danger:hover{ background:#b91c1c !important; }
    .loading-spinner{ display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite; margin-right:8px; }
    @keyframes spin{ 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }
    .sticky-header thead th{ position:sticky; top:0; background:#f5f7fa; z-index:10; }
    .search-container{ margin:10px 0; }
    .search-input{ width:300px; padding:8px; border:1px solid var(--border); border-radius:8px; }
    .preview-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:9999; }
    .preview-overlay img{ max-width:90vw; max-height:90vh; border-radius:8px; }
    .preview-close{ position:absolute; top:20px; right:20px; background:#fff; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:20px; }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header / Logo + meta -->
    <div class="card">
      <div class="quote-head">
        <img id="qo-logo" class="logo" alt="Logo" />
        <div>
          <div style="font-size:18px; font-weight:700">عرض سعر / Quotation</div>
          <div class="muted">رقم العرض: <span id="qo-number"></span> • التاريخ: <span id="qo-date"></span></div>
          <div class="muted">العملة: <span id="qo-currency-view"></span> • شروط السداد الافتراضية: 50% مقدمة + 50% بعد الاستلام</div>
        </div>
        <div class="right no-print flex">
          <button id="btn-print" class="btn">طباعة / PDF</button>
          <button id="btn-save" class="btn btn-ok">حفظ كمسودة</button>
        </div>
      </div>
      <div class="notice no-print">لو عندك عناصر “Staged” من الشات، الصفحة هتقرأها تلقائيًا من <code>localStorage</code> (المفتاح <code>qiq_staged_items</code>).</div>
    </div>

    <!-- Client & Project -->
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>بيانات العميل (اسم الشركة/الجهة)</label>
          <input id="client-name" placeholder="مثال: ACME Systems" />
        </div>
        <div class="col-3">
          <label>الشخص المسؤول</label>
          <input id="client-contact" placeholder="الاسم" />
        </div>
        <div class="col-3">
          <label>البريد الإلكتروني</label>
          <input id="client-email" type="email" placeholder="name@example.com" />
        </div>
        <div class="col-3">
          <label>الهاتف</label>
          <input id="client-phone" placeholder="+20..." />
        </div>
        <div class="col-3">
          <label>اسم المشروع</label>
          <input id="project-name" placeholder="Project X" />
        </div>
        <div class="col-3">
          <label>صاحب / مالك المشروع (إن وجد)</label>
          <input id="project-owner" placeholder="Owner name" />
        </div>
        <div class="col-3">
          <label>المقاول العام (إن وجد)</label>
          <input id="main-contractor" placeholder="General Contractor" />
        </div>
        <div class="col-3">
          <label>موقع التنفيذ</label>
          <input id="site-location" placeholder="City, Country" />
        </div>
        <div class="col-3">
          <label>العملة</label>
          <select id="currency">
            <option value="USD">$ USD</option>
            <option value="EUR">€ EUR</option>
            <option value="EGP">جنيه EGP</option>
            <option value="AED">د.إ AED</option>
            <option value="SAR">ر.س SAR</option>
          </select>
        </div>
        <div class="col-3">
          <label>تاريخ العرض</label>
          <input id="quote-date" type="date" />
        </div>
        <div class="col-6 checkbox">
          <input id="need-assist" type="checkbox" />
          <label for="need-assist" style="margin:0">أحتاج مكالمة/مساعدة قبل استلام العرض</label>
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="card">
      <div class="flex">
        <div style="font-weight:700">بنود عرض السعر</div>
        <div class="right no-print flex">
          <button id="btn-clear-all" class="btn btn-danger">مسح الكل</button>
          <button id="btn-import-excel" class="btn btn-primary">استيراد Excel</button>
          <button id="btn-export-csv" class="btn">تصدير CSV</button>
          <button id="btn-export-excel" class="btn">تصدير XLSX</button>
          <button id="btn-add-row" class="btn">إضافة بند يدوي</button>
          <button id="btn-load-staged" class="btn">تحميل البنود من الشات</button>
        </div>
      </div>
      
      <!-- Search/Filter -->
      <div class="search-container no-print">
        <input id="search-input" class="search-input" placeholder="البحث في البنود (الوصف أو PN/SKU)..." />
      </div>
      
      <div class="table-wrap">
        <table id="items-table" class="sticky-header" aria-label="Quote items">
          <thead>
            <tr>
              <th style="width:40%">الوصف / PN / SKU</th>
              <th style="width:14%">سعر الوحدة</th>
              <th style="width:12%">الكمية</th>
              <th style="width:16%">الإجمالي</th>
              <th class="no-print" style="width:18%">إجراءات</th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:left">الإجمالي الفرعي (Subtotal):</td>
              <td id="subtotal-cell">-</td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td colspan="3" class="checkbox" style="text-align:left">
                <input id="include-install" type="checkbox" />
                <label for="include-install" style="margin:0">إضافة بند تركيب اختياري (5% من الإجمالي الفرعي)</label>
              </td>
              <td id="install-cell">0</td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td colspan="3" style="text-align:left">الإجمالي الكلي (Grand Total):</td>
              <td id="grand-cell"><strong>-</strong></td>
              <td class="no-print"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <!-- Hidden file input for Excel import -->
      <input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display:none" />
    </div>

    <!-- Payments & Terms -->
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>طريقة الدفع الافتراضية</label>
          <textarea id="payment-terms">50% دفعة مقدمة عند تأكيد الطلب، 50% عند الاستلام. أعمال التركيبات — إن طُلبت — يتم سدادها بشكل مستقل وفق الجداول الزمنية المتفق عليها.</textarea>
          <div class="muted">يمكنك تعديل النص حسب سياسة شركتك.</div>
        </div>
        <div class="col-6">
          <label>الشروط والأحكام (Terms & Conditions)</label>
          <textarea id="terms">الأسعار لا تشمل الضرائب أو الرسوم الجمركية إن وجدت. صلاحية العرض 14 يومًا من تاريخ الإصدار ما لم يُذكر خلاف ذلك. قد تختلف مواعيد التسليم بناءً على التوفر. أي تغييرات في النطاق قد تؤثر على الأسعار والمواعيد.</textarea>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card no-print">
      <div class="flex">
        <div class="muted">سيتّم تضمين اللوجو والعناوين والبيانات أعلاه في عرض السعر المطبوع/المحفوظ PDF.</div>
        <div class="right flex">
          <button id="btn-generate" class="btn btn-primary">تحديث الإجماليات</button>
          <button id="btn-request-special" class="btn">طلب سعر مُخصّص بعد التحقق</button>
          <button id="btn-submit" class="btn btn-ok">إرسال الطلب</button>
        </div>
      </div>
    </div>

    <!-- Hidden payload preview (for debug) -->
    <pre id="payload-preview" class="card print-only" style="white-space:pre-wrap;word-wrap:break-word"></pre>

    <!-- Image Preview Overlay -->
    <div id="image-preview-overlay" class="preview-overlay">
      <button class="preview-close" onclick="closeImagePreview()">×</button>
      <img id="preview-image" src="" alt="Preview" />
    </div>

  </div>

  <script src="/js/quote.js"></script>
</body>
</html>
