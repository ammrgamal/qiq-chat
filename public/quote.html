<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุทูุจ ุนุฑุถ ุณุนุฑ | QuickITQuote</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- SheetJS for Excel import/export functionality -->
  <script>
    // Simple Excel-compatible CSV with .xls extension as fallback if SheetJS fails
    window.XLSX_FALLBACK = true;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="console.warn('XLSX library failed to load, using fallback')"></script>
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; --accent:#2563eb; --bg:#f8fafc; --ok:#059669; }
    body{ font-family:Inter,system-ui,Segoe UI,Arial; background:#fff; color:#111; margin:0 }
    .container{ max-width:1000px; margin:20px auto; padding:16px }
    .card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; margin-bottom:14px }
    .row{ display:grid; gap:10px; grid-template-columns:repeat(12,1fr) }
    .col-12{ grid-column:span 12 } .col-6{ grid-column:span 6 } .col-4{ grid-column:span 4 } .col-3{ grid-column:span 3 }
    label{ font-size:13px; color:#374151; display:block; margin-bottom:6px }
    input,select,textarea{ width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px; background:#fff }
    textarea{ min-height:90px; resize:vertical }
    .muted{ color:var(--muted); font-size:12px }
    .flex{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .right{ margin-inline-start:auto }
    .btn{ border:0; border-radius:10px; padding:10px 14px; background:#374151; color:#fff; cursor:pointer }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-primary{ background:var(--accent) }
    .btn-ok{ background:var(--ok) }
    .table-wrap{ overflow:auto }
  table{ width:100%; border-collapse:collapse; table-layout:fixed }
  th,td{ border-bottom:1px solid var(--border); padding:10px; vertical-align:top; text-align:right }
    tfoot td{ font-weight:700 }
    .totals{ display:grid; gap:8px; grid-template-columns:1fr auto; align-items:center; margin-top:10px }
    .quote-head{ display:flex; align-items:center; gap:14px; margin:8px 0 14px }
    .logo{ width:120px; height:56px; object-fit:contain; border:1px dashed var(--border); border-radius:8px; background:#fff }
    .print-only{ display:none }
    @media print{
      .no-print{ display:none !important }
      .print-only{ display:block }
      body{ background:#fff }
      .card{ break-inside:avoid }
      @page {
        margin: 0.5in;
        size: A4;
      }
      body > footer, .print-footer {
        display: none !important;
      }
    }
    .notice{ background:#f0f9ff; border:1px solid #dbeafe; color:#0c4a6e; padding:8px 10px; border-radius:10px; font-size:13px }
    .checkbox{ display:flex; align-items:center; gap:8px }
    .btn-danger{ background:#dc2626 !important; }
    .btn-danger:hover{ background:#b91c1c !important; }
    .loading-spinner{ display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite; margin-right:8px; }
    @keyframes spin{ 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }
    .sticky-header thead th{ position:sticky; top:0; background:#f5f7fa; z-index:10; }
    .search-container{ margin:10px 0; }
    .search-input{ width:300px; padding:8px; border:1px solid var(--border); border-radius:8px; }
    .preview-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:9999; }
    .preview-overlay img{ max-width:90vw; max-height:90vh; border-radius:8px; }
    .preview-close{ position:absolute; top:20px; right:20px; background:#fff; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:20px; }
    /* Chat-like product row style */
    .compact-quote-table .product-desc{display:flex;flex-direction:column;gap:4px}
    .compact-quote-table .product-name{font-weight:600}
    .compact-quote-table .product-details{display:flex;gap:6px;flex-wrap:wrap}
    .compact-quote-table .product-details .product-pn,
    .compact-quote-table .product-details .product-brand{background:#f3f4f6;border-radius:999px;padding:2px 8px;font-size:12px;color:#374151}
    .compact-quote-table .qty-input{width:64px;text-align:center}
    .compact-quote-table .numeric{white-space:nowrap;text-align:right}
    .compact-quote-table .action-icons{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header / Logo + meta -->
    <div class="card">
      <div class="quote-head">
        <img id="qo-logo" class="logo" alt="Logo" />
        <div>
          <div style="font-size:18px; font-weight:700">ุนุฑุถ ุณุนุฑ / Quotation</div>
          <div class="muted">ุฑูู ุงูุนุฑุถ: <span id="qo-number"></span> โข ุงูุชุงุฑูุฎ: <span id="qo-date"></span></div>
          <div class="muted">ุงูุนููุฉ: <span id="qo-currency-view"></span> โข ุดุฑูุท ุงูุณุฏุงุฏ ุงูุงูุชุฑุงุถูุฉ: 50% ููุฏูุฉ + 50% ุจุนุฏ ุงูุงุณุชูุงู</div>
        </div>
        <div class="right no-print flex">
          <button id="btn-load-staged" class="btn">ุชุญููู ูู ุงูุดุงุช</button>
          <button id="btn-print" class="btn">ุทุจุงุนุฉ / PDF</button>
          <button id="btn-save-pdf-account" class="btn btn-primary">ุญูุธ ูู ุญุณุงุจู ูู PDF</button>
          <button id="btn-save" class="btn btn-ok">ุญูุธ ููุณูุฏุฉ</button>
        </div>
      </div>
      <div class="notice no-print">ูู ุนูุฏู ุนูุงุตุฑ โStagedโ ูู ุงูุดุงุชุ ุงูุตูุญุฉ ูุชูุฑุฃูุง ุชููุงุฆููุง ูู <code>localStorage</code> (ุงูููุชุงุญ <code>qiq_staged_items</code>).</div>
    </div>

    <!-- Client & Project -->
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>ุจูุงูุงุช ุงูุนููู (ุงุณู ุงูุดุฑูุฉ/ุงูุฌูุฉ)</label>
          <input id="client-name" placeholder="ูุซุงู: ACME Systems" />
        </div>
        <div class="col-3">
          <label>ุงูุดุฎุต ุงููุณุคูู</label>
          <input id="client-contact" placeholder="ุงูุงุณู" />
        </div>
        <div class="col-3">
          <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input id="client-email" type="email" placeholder="name@example.com" />
          <div class="email-hint">Please use your business email for faster response.</div>
        </div>
        <div class="col-3">
          <label>ุงููุงุชู</label>
          <input id="client-phone" placeholder="+20..." />
        </div>
        <div class="col-3">
          <label>ุงุณู ุงููุดุฑูุน</label>
          <input id="project-name" placeholder="Project X" />
        </div>
        <div class="col-3">
          <label>ุตุงุญุจ / ูุงูู ุงููุดุฑูุน (ุฅู ูุฌุฏ)</label>
          <input id="project-owner" placeholder="Owner name" />
        </div>
        <div class="col-3">
          <label>ุงูููุงูู ุงูุนุงู (ุฅู ูุฌุฏ)</label>
          <input id="main-contractor" placeholder="General Contractor" />
        </div>
        <div class="col-3">
          <label>ูููุน ุงูุชูููุฐ</label>
          <input id="site-location" placeholder="City, Country" />
        </div>
        <div class="col-3">
          <label>ุงูุนููุฉ</label>
          <select id="currency">
            <option value="USD">$ USD</option>
            <option value="EUR">โฌ EUR</option>
            <option value="EGP">ุฌููู EGP</option>
            <option value="AED">ุฏ.ุฅ AED</option>
            <option value="SAR">ุฑ.ุณ SAR</option>
          </select>
        </div>
        <div class="col-3">
          <label>ุชุงุฑูุฎ ุงูุนุฑุถ</label>
          <input id="quote-date" type="date" />
        </div>
        <div class="col-3">
          <label>ููุนุฏ ุงูุชูููุฐ ุงููุชููุน</label>
          <input id="execution-date" type="date" />
        </div>
        <div class="col-6 checkbox">
          <input id="need-assist" type="checkbox" />
          <label for="need-assist" style="margin:0">ุฃุญุชุงุฌ ููุงููุฉ/ูุณุงุนุฏุฉ ูุจู ุงุณุชูุงู ุงูุนุฑุถ</label>
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="card">
      <div class="flex">
        <div style="font-weight:700">ุจููุฏ ุนุฑุถ ุงูุณุนุฑ</div>
        <div class="right no-print flex">
          <button id="btn-clear-all" class="btn btn-danger">ูุณุญ ุงููู</button>
          <button id="btn-import-excel" class="btn btn-primary">ุงุณุชูุฑุงุฏ Excel</button>
          <button id="btn-export-csv" class="btn">ุชุตุฏูุฑ CSV</button>
          <button id="btn-export-excel" class="btn">ุชุตุฏูุฑ XLSX</button>
          <button id="btn-add-row" class="btn">ุฅุถุงูุฉ ุจูุฏ ูุฏูู</button>
        </div>
      </div>
      
      <!-- User Guidance Note -->
      <div class="quote-guidance no-print">
        Add products, edit quantities, then request your quote.
      </div>
      
      <!-- Search/Filter -->
      <div class="search-container no-print">
        <input id="search-input" class="search-input" placeholder="ุงูุจุญุซ ูู ุงูุจููุฏ (ุงููุตู ุฃู PN/SKU)..." />
      </div>
      
      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display:none">
        <div class="empty-state-content">
          <div class="empty-icon">๐ฆ</div>
          <div class="empty-message">Add products to start your quote.</div>
        </div>
      </div>
      
      <div class="table-wrap">
        <table id="items-table" class="compact-quote-table sticky-header" aria-label="Quote items">
          <thead>
            <tr>
              <th style="width:86%">Description / PN / SKU</th>
              <th style="width:3%">QTY</th>
              <th style="width:4%">Price</th>
              <th style="width:4%">Total</th>
              <th class="no-print" style="width:3%">Action</th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:left">ุงูุฅุฌูุงูู ุงููุฑุนู (Subtotal):</td>
              <td id="subtotal-cell" class="numeric">-</td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td colspan="3" class="checkbox" style="text-align:left">
                <input id="include-install" type="checkbox" />
                <label for="include-install" style="margin:0">ุฅุถุงูุฉ ุจูุฏ ุชุฑููุจ ุงุฎุชูุงุฑู (5% ูู ุงูุฅุฌูุงูู ุงููุฑุนู โ ุญุฏ ุฃุฏูู 200$)</label>
              </td>
              <td id="install-cell" class="numeric">0</td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td colspan="3" style="text-align:left">ุงูุฅุฌูุงูู ุงูููู (Grand Total):</td>
              <td id="grand-cell" class="numeric"><strong>-</strong></td>
              <td class="no-print"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <!-- Hidden file input for Excel import -->
      <input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display:none" />
    </div>

    <!-- Payments & Terms -->
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>ุทุฑููุฉ ุงูุฏูุน ุงูุงูุชุฑุงุถูุฉ</label>
          <textarea id="payment-terms">50% ุฏูุนุฉ ููุฏูุฉ ุนูุฏ ุชุฃููุฏ ุงูุทูุจุ 50% ุนูุฏ ุงูุงุณุชูุงู. ุฃุนูุงู ุงูุชุฑููุจุงุช โ ุฅู ุทููุจุช โ ูุชู ุณุฏุงุฏูุง ุจุดูู ูุณุชูู ููู ุงูุฌุฏุงูู ุงูุฒูููุฉ ุงููุชูู ุนูููุง.</textarea>
          <div class="muted">ููููู ุชุนุฏูู ุงููุต ุญุณุจ ุณูุงุณุฉ ุดุฑูุชู.</div>
        </div>
        <div class="col-6">
          <label>ุงูุดุฑูุท ูุงูุฃุญูุงู (Terms & Conditions)</label>
          <textarea id="terms">ุงูุฃุณุนุงุฑ ูุง ุชุดูู ุงูุถุฑุงุฆุจ ุฃู ุงูุฑุณูู ุงูุฌูุฑููุฉ ุฅู ูุฌุฏุช. ุตูุงุญูุฉ ุงูุนุฑุถ 14 ููููุง ูู ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ ูุง ูู ููุฐูุฑ ุฎูุงู ุฐูู. ูุฏ ุชุฎุชูู ููุงุนูุฏ ุงูุชุณููู ุจูุงุกู ุนูู ุงูุชููุฑ. ุฃู ุชุบููุฑุงุช ูู ุงููุทุงู ูุฏ ุชุคุซุฑ ุนูู ุงูุฃุณุนุงุฑ ูุงูููุงุนูุฏ.</textarea>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card no-print">
      <div class="flex">
        <div class="muted">ุณูุชูู ุชุถููู ุงูููุฌู ูุงูุนูุงููู ูุงูุจูุงูุงุช ุฃุนูุงู ูู ุนุฑุถ ุงูุณุนุฑ ุงููุทุจูุน/ุงููุญููุธ PDF.</div>
        <div class="right flex">
          <button id="btn-generate" class="btn btn-primary">ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช</button>
          <button id="btn-request-special" class="btn">ุทูุจ ุณุนุฑ ููุฎุตูุต ุจุนุฏ ุงูุชุญูู</button>
          <button id="btn-submit" class="btn btn-ok">ุฅุฑุณุงู ุงูุทูุจ</button>
        </div>
      </div>
      
      <!-- Proceed to Request Quote CTA -->
      <div id="proceed-cta" class="proceed-cta" style="display:none">
        <button id="btn-proceed-quote" class="btn-proceed">
          <span class="proceed-icon">๐</span>
          <span class="proceed-text">Proceed to Request Quote</span>
        </button>
      </div>
    </div>

    <!-- Hidden payload preview (for debug) -->
    <pre id="payload-preview" class="card print-only" style="white-space:pre-wrap;word-wrap:break-word"></pre>

    <!-- Image Preview Overlay -->
    <div id="image-preview-overlay" class="preview-overlay">
      <button class="preview-close" onclick="closeImagePreview()">ร</button>
      <img id="preview-image" src="" alt="Preview" />
    </div>

  </div>
  <script src="js/toast.js"></script>
  <script src="js/quote.js"></script>
</body>
</html>
