<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>طلب عرض سعر | QuickITQuote</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- SheetJS for Excel import/export functionality -->
  <script>
    // Simple Excel-compatible CSV with .xls extension as fallback if SheetJS fails
    window.XLSX_FALLBACK = true;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="console.warn('XLSX library failed to load, using fallback')"></script>
  <!-- pdfmake for PDF generation -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>
  <script src="/js/pdf-arabic-fonts.js"></script>
  
  <!-- Visitor Tracking -->
  <script src="/js/visitor-tracker.js"></script>
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; --accent:#2563eb; --bg:#f8fafc; --ok:#059669; }
    body{ font-family:Inter,system-ui,Segoe UI,Arial; background:#fff; color:#111; margin:0 }
    .container{ max-width:1000px; margin:20px auto; padding:16px }
    .card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; margin-bottom:14px }
    .row{ display:grid; gap:10px; grid-template-columns:repeat(12,1fr) }
    .col-12{ grid-column:span 12 } .col-6{ grid-column:span 6 } .col-4{ grid-column:span 4 } .col-3{ grid-column:span 3 }
    label{ font-size:13px; color:#374151; display:block; margin-bottom:6px }
    input,select,textarea{ width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px; background:#fff }
    textarea{ min-height:90px; resize:vertical }
    .muted{ color:var(--muted); font-size:12px }
    .flex{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .right{ margin-inline-start:auto }
    .btn{ border:0; border-radius:10px; padding:10px 14px; background:#374151; color:#fff; cursor:pointer }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-primary{ background:var(--accent) }
    .btn-ok{ background:var(--ok) }
    .table-wrap{ overflow:auto }
  table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed }
  th,td{ border-bottom:1px solid var(--border); padding:8px 10px; vertical-align:middle; text-align:right }
  thead th{ background:#f8fafc; font-weight:600 }
  tbody td{ line-height:1.35 }
  .desc-col .product-name{ font-weight:600 }
  .desc-col .product-details{ opacity:.9 }
    tfoot td{ font-weight:700 }
    .totals{ display:grid; gap:8px; grid-template-columns:1fr auto; align-items:center; margin-top:10px }
    .quote-head{ display:flex; align-items:center; gap:14px; margin:8px 0 14px }
    .logo{ width:120px; height:56px; object-fit:contain; border:1px dashed var(--border); border-radius:8px; background:#fff }
    .print-only{ display:none }
    @media print{
      .no-print{ display:none !important }
      .print-only{ display:block }
      body{ background:#fff }
      .card{ break-inside:avoid }
      @page {
        margin: 0.5in;
        size: A4;
      }
      body > footer, .print-footer {
        display: none !important;
      }
    }
    .notice{ background:#f0f9ff; border:1px solid #dbeafe; color:#0c4a6e; padding:8px 10px; border-radius:10px; font-size:13px }
    .checkbox{ display:flex; align-items:center; gap:8px }
    .btn-danger{ background:#dc2626 !important; }
    .btn-danger:hover{ background:#b91c1c !important; }
    .loading-spinner{ display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite; margin-right:8px; }
    @keyframes spin{ 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }
  .sticky-header thead th{ position:sticky; top:0; background:#f5f7fa; z-index:10; }
    .search-container{ margin:10px 0; }
    .search-input{ width:300px; padding:8px; border:1px solid var(--border); border-radius:8px; }
    .preview-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:9999; }
    .preview-overlay img{ max-width:90vw; max-height:90vh; border-radius:8px; }
  .screen-only{ display:block }
    /* Chat-like product row style */
    .compact-quote-table .product-desc{display:flex;flex-direction:column;gap:4px}
    .compact-quote-table .product-details{display:flex;gap:6px;flex-wrap:wrap}
    .compact-quote-table .product-details .product-pn,
    .compact-quote-table .product-details .product-brand{background:#f3f4f6;border-radius:999px;padding:2px 8px;font-size:12px;color:#374151}
    .compact-quote-table .qty-input{width:64px;text-align:center}
    .compact-quote-table .numeric{white-space:nowrap;text-align:right}
  .compact-quote-table .action-icons{display:flex;gap:6px;align-items:center}
  /* Chat-like vibes */
  .compact-quote-table tbody tr:nth-child(odd){background:#fafafa}
  .compact-quote-table tbody tr:hover{background:#f3f4f6}

  /* Required field marker */
  .req-star{ color:#dc2626; margin-inline-start:4px; font-weight:700 }

    /* Improved spacing + thumbnail in description */
    .compact-quote-table .desc-flex{display:flex;gap:10px;align-items:flex-start}
    .compact-quote-table .thumb{width:40px;height:40px;border-radius:8px;object-fit:cover;flex:0 0 auto;cursor:zoom-in;border:1px solid var(--border);background:#fff}
    .compact-quote-table .qty-col{width:80px;text-align:center}
    .compact-quote-table .price-col{width:120px}
    .compact-quote-table .total-col{width:130px}
    .compact-quote-table .actions-col{width:80px}
    .compact-quote-table td, .compact-quote-table th{vertical-align:top}

  /* Project Info Modal */
  .proj-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:99999}
  .proj-modal{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);width:min(520px,96vw);padding:16px}
  .proj-modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .proj-modal h3{margin:0;font-size:18px}
  .proj-modal .row{display:grid;gap:8px;grid-template-columns:1fr}
  .proj-modal label{font-size:13px;color:#374151;margin-bottom:4px}
  .proj-modal input, .proj-modal textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:14px}
  .proj-modal footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .proj-btn{border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .proj-btn.primary{background:#059669;color:#fff}
  .proj-btn.secondary{background:#6b7280;color:#fff}
  </style>
</head>
<body>
  <div class="topbar" style="position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb">
    <div class="topbar-inner" style="max-width:1000px;margin:0 auto;padding:10px 12px;display:flex;gap:12px;align-items:center">
      <div class="brand" style="display:flex;gap:10px;align-items:center;color:#1e3a8a;font-weight:700">
        <span class="dot" style="width:8px;height:8px;border-radius:50%;background:#0ea5e9"></span>
        <a href="https://ai.quickitquote.com/" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">QuickITQuote</a>
        <span class="muted" style="font-weight:500">Quote</span>
      </div>
      <div class="view-toggle" style="margin-inline-start:auto;display:flex;gap:6px">
        <a class="btn ghost" href="/index.html" title="AI Agent">AI Agent</a>
        <button id="themeToggleQuote" class="btn secondary" title="Theme">🌙</button>
      </div>
    </div>
  </div>
  <div class="container">
    <!-- Header / Logo + meta -->
    <div class="card">
      <div class="quote-head">
      <!-- Print header/footer -->
      <div class="print-only" style="margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="/logo.png" alt="Logo" style="width:120px;height:56px;object-fit:contain;border:1px solid #e5e7eb;border-radius:8px" onerror="this.src='https://via.placeholder.com/200x80?text=LOGO'"/>
          <div style="font-weight:700;font-size:18px">QuickITQuote  Quotation</div>
          <div style="margin-inline-start:auto;text-align:right;color:#6b7280;font-size:12px">
            no-reply@quickitquote.com<br/>
            quickitquote.com
          </div>
        </div>
        <hr style="border:0;border-top:1px solid #e5e7eb;margin:8px 0"/>
      </div>
  <img id="qo-logo" class="logo no-print" alt="Logo" />
        <div>
          <div style="font-size:18px; font-weight:700">عرض سعر / Quotation</div>
          <div class="muted">رقم العرض: <span id="qo-number"></span> • التاريخ: <span id="qo-date"></span></div>
          <div class="muted">العملة: <span id="qo-currency-view"></span> • شروط السداد الافتراضية: 50% مقدمة + 50% بعد الاستلام</div>
        </div>
        <div class="right no-print flex">
          <button id="btn-load-staged" class="btn" style="display:none">تحميل من الشات</button>
          <button id="btn-print" class="btn" style="display:none">طباعة / PDF</button>
          <button id="btn-export-pdfmake" class="btn btn-primary">تصدير PDF</button>
          <button id="btn-save" class="btn btn-ok">حفظ كمسودة</button>
        </div>
      </div>
      <div class="notice no-print">لو عندك عناصر “Staged” من الشات، الصفحة هتقرأها تلقائيًا من <code>localStorage</code> (المفتاح <code>qiq_staged_items</code>).</div>
    </div>

    <!-- Client & Project -->
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>بيانات العميل (اسم الشركة/الجهة)</label>
          <input id="client-name" placeholder="مثال: ACME Systems" />
        </div>
        <div class="col-3">
          <label>الشخص المسؤول <span class="req-star">*</span></label>
          <input id="client-contact" placeholder="Owner/Manager (English)" required />
        </div>
        <div class="col-3">
          <label>البريد الإلكتروني (Business) <span class="req-star">*</span></label>
          <input id="client-email" type="email" placeholder="name@company.com" required />
          <div class="email-hint">Please use your business email for faster response.</div>
        </div>
        <div class="col-3">
          <label>الهاتف <span class="req-star">*</span></label>
          <input id="client-phone" placeholder="+20... (English digits)" required />
        </div>
        <div class="col-3">
          <label>اسم المشروع <span class="req-star">*</span></label>
          <input id="project-name" placeholder="Project X (English)" required />
        </div>
        <div class="col-3">
          <label>صفة الطالب (Requester Role) <span class="req-star">*</span></label>
          <select id="requester-role" required>
            <option value="">— اختر —</option>
            <option>IT Manager</option>
            <option>Procurement</option>
            <option>Owner/Founder</option>
            <option>Operations</option>
            <option>Consultant</option>
            <option>Other</option>
          </select>
        </div>
        <div class="col-3">
          <label>صاحب / مالك المشروع (إن وجد)</label>
          <input id="project-owner" placeholder="Owner name (English)" />
        </div>
        <div class="col-3">
          <label>المقاول العام (إن وجد)</label>
          <input id="main-contractor" placeholder="General Contractor (English)" />
        </div>
        <div class="col-3">
          <label>موقع التنفيذ</label>
          <input id="site-location" placeholder="City, Country (English)" />
        </div>
        <div class="col-3">
          <label>العملة</label>
          <select id="currency">
            <option value="USD">$ USD</option>
            <option value="EUR">€ EUR</option>
            <option value="EGP">جنيه EGP</option>
            <option value="AED">د.إ AED</option>
            <option value="SAR">ر.س SAR</option>
          </select>
        </div>
        <div class="col-3">
          <label>تاريخ العرض</label>
          <input id="quote-date" type="date" />
        </div>
        <div class="col-3">
          <label>موعد التنفيذ المتوقع <span class="req-star">*</span></label>
          <input id="execution-date" type="date" required />
        </div>
        <div class="col-3">
          <label>موعد الإغلاق المتوقع (Expected Closing) <span class="req-star">*</span></label>
          <input id="expected-close" type="date" required />
        </div>
        <div class="col-6 checkbox">
          <input id="need-assist" type="checkbox" />
          <label for="need-assist" style="margin:0">أحتاج مكالمة/مساعدة قبل استلام العرض</label>
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="card">
      <div class="flex">
        <div style="font-weight:700">بنود عرض السعر</div>
        <div class="right no-print flex">
          <label class="checkbox" style="margin-inline-end:8px"><input id="boq-images-toggle" type="checkbox"/> <span class="muted">إظهار صور مصغّرة في جدول BOQ</span></label>
          <button id="btn-clear-all" class="btn btn-danger">مسح الكل</button>
          <button id="btn-export-excel" class="btn">تصدير XLSX</button>
        </div>
      </div>
      
      <!-- User Guidance Note -->
      <div class="quote-guidance no-print">
        أضِف المنتجات وعدّل الكميات، ثم أرسِل طلب عرض السعر.
      </div>
      
      <!-- Search/Filter -->
      <div class="search-container no-print">
  <input id="search-input" class="search-input" placeholder="ابحث في البنود (الوصف أو PN)..." />
      </div>
      
      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display:none">
        <div class="empty-state-content">
          <div class="empty-icon">📦</div>
          <div class="empty-message">أضِف منتجات لبدء عرض السعر.</div>
        </div>
      </div>
      
      <div class="table-wrap">
        <table id="items-table" class="compact-quote-table sticky-header" aria-label="Quote items">
          <thead>
            <tr>
              <th class="desc-col">Description / PN</th>
              <th class="qty-col">QTY</th>
              <th class="price-col">Price</th>
              <th class="total-col">Total</th>
              <th class="actions-col no-print">Action</th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:left">الإجمالي الفرعي (Subtotal):</td>
              <td id="subtotal-cell" class="numeric">-</td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td colspan="3" class="checkbox" style="text-align:left">
                <input id="include-install" type="checkbox" />
                <label for="include-install" style="margin:0">إضافة بند تركيب اختياري (5% من الإجمالي الفرعي — حد أدنى 200$)</label>
              </td>
              <td id="install-cell" class="numeric">0</td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td colspan="3" style="text-align:left">الإجمالي الكلي (Grand Total):</td>
              <td id="grand-cell" class="numeric"><strong>-</strong></td>
              <td class="no-print"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      
  <!-- (تم إلغاء الاستيراد من Excel في صفحة الكوت بناءً على المتطلبات) -->
    </div>

    <!-- Payments & Terms -->
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>طريقة الدفع الافتراضية</label>
          <textarea id="payment-terms">50% advance upon order confirmation, 50% upon delivery. Installation/professional services — if requested — are billed separately according to agreed schedules.</textarea>
          <div class="muted">Please write in English; Arabic text will be omitted in the generated PDF.</div>
        </div>
        <div class="col-6">
          <label>الشروط والأحكام (Terms & Conditions)</label>
          <textarea id="terms">Prices exclude VAT/taxes and customs (if applicable). Offer validity is 14 days from issue date unless otherwise stated. Delivery dates depend on availability. Any scope changes may affect pricing and timelines.</textarea>
          <div class="muted">Please write in English; Arabic text will be omitted in the generated PDF.</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card no-print">
      <div class="flex">
        <div class="muted">سيتّم تضمين اللوجو والعناوين والبيانات أعلاه في عرض السعر المطبوع/المحفوظ PDF.</div>
        <div class="right flex">
          <button id="btn-generate" class="btn btn-primary" style="display:none">تحديث الإجماليات</button>
          <button id="btn-request-special" class="btn" style="display:none">طلب سعر مُخصّص بعد التحقق</button>
          <button id="btn-request-maintenance" class="btn" style="display:none">طلب عقد صيانة</button>
          <button id="btn-submit" class="btn btn-ok">إرسال الطلب</button>
        </div>
      </div>
      <!-- Connectivity status (inline helper) -->
      <div id="qiq-connectivity" class="muted" style="margin-top:8px;font-size:12px"></div>
      
      <!-- Proceed to Request Quote CTA -->
      <div id="proceed-cta" class="proceed-cta" style="display:none">
        <button id="btn-proceed-quote" class="btn-proceed">
          <span class="proceed-icon">📋</span>
          <span class="proceed-text">Proceed to Request Quote</span>
        </button>
      </div>
    </div>

    <!-- AI Comparison (if attached) -->
    <div id="ai-comparison-card" class="card" style="display:none">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <div style="font-weight:700">AI Comparison</div>
        <button id="btn-remove-attachment" class="btn secondary no-print">Remove</button>
      </div>
      <div id="ai-comparison-content" style="white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-top:8px"></div>
    </div>

    <!-- Hidden payload preview (for debug) -->
    <pre id="payload-preview" class="card print-only" style="white-space:pre-wrap;word-wrap:break-word"></pre>

    <!-- Image Preview Overlay -->
    <div id="image-preview-overlay" class="preview-overlay">
      <button class="preview-close" onclick="closeImagePreview()">×</button>
      <img id="preview-image" src="" alt="Preview" />
    </div>

  </div>
  <!-- Project Info Modal -->
  <div id="project-info-modal" class="proj-modal-backdrop" aria-hidden="true" role="dialog" aria-label="بيانات المشروع">
    <div class="proj-modal" role="document">
      <header>
        <h3>📋 بيانات المشروع</h3>
        <button id="proj-info-cancel" class="proj-btn secondary" type="button">إلغاء</button>
      </header>
      <div class="row">
        <div>
          <label>اسم المشروع <span style="color:#dc2626">*</span></label>
          <input id="proj-modal-name" type="text" placeholder="مثال: نظام أمن المبنى الإداري" />
        </div>
        <div>
          <label>موقع التنفيذ</label>
          <input id="proj-modal-site" type="text" placeholder="مدينة، دولة" />
        </div>
        <div>
          <label>موعد التنفيذ المتوقع</label>
          <input id="proj-modal-exec" type="date" />
        </div>
      </div>
      <footer>
        <button id="proj-info-save" class="proj-btn primary" type="button">حفظ</button>
      </footer>
    </div>
  </div>
  <div class="print-only" style="margin-top:12px">
    <hr style="border:0;border-top:1px solid #e5e7eb;margin:8px 0"/>
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;color:#6b7280;font-size:12px">
      <div>Thank you for considering QuickITQuote.</div>
      <div>Page <span class="pageNumber"></span></div>
    </div>
  </div>
  <script src="js/toast.js"></script>
  <script src="/js/experimental-banner.js"></script>
  <script src="js/quote.js"></script>
  <script>
    // Render a tiny connectivity line from /health for quick diagnostics
    (function(){
      function chip(name, ok){
        const color = ok ? '#166534' : '#991b1b';
        return `<span style="display:inline-block;margin-inline-end:8px;color:${color}">${name}:${ok?'OK':'—'}</span>`;
      }
      fetch('/health').then(r=>r.json()).then(h=>{
        const env = h?.env || {};
        const html = [
          chip('HelloLeads', !!env.hasHelloLeads),
          chip('Resend', !!env.hasResend),
          chip('OpenAI', !!env.hasOpenAI),
          chip('Gemini', !!env.hasGemini),
          chip('AUTO_APPROVE', !!env.autoApprove)
        ].join(' ');
        const el = document.getElementById('qiq-connectivity');
        if (el) el.innerHTML = html;
      }).catch(()=>{});
    })();
  </script>
</body>
</html>
